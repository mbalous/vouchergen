---
import '../styles/global.css';
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap"
			rel="stylesheet"
		/>
		<title>Voucher Generator</title>
	</head>
	<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
		<main class="w-full max-w-6xl bg-white rounded-lg shadow-xl p-8">
			<h1 class="text-3xl font-bold mb-8 text-center text-gray-800">Gift Voucher Generator</h1>
			
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
				<!-- Controls -->
				<div class="space-y-4 lg:col-span-1">
					<div>
						<label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
						<input 
							type="text"
							id="input-title"
							class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							value="Gift Voucher"
						/>
					</div>

					<div>
						<label class="block text-sm font-medium text-gray-700 mb-1">Subtitle</label>
						<input 
							type="text"
							id="input-subtitle"
							class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							value="A special treat just for you"
						/>
					</div>

					<div>
						<label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
						<textarea 
							id="input-address"
							class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							rows="3"
						>123 Main St,&#10;Cityville, ST 12345</textarea>
					</div>

					<div>
						<label class="block text-sm font-medium text-gray-700 mb-1">Valid Till</label>
						<input 
							type="text"
							id="input-valid-till"
							class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
							value="December 31, 2025"
						/>
					</div>
					
					<div>
						<label class="block text-sm font-medium text-gray-700 mb-1">Background Image</label>
						<input 
							type="file" 
							id="bg-upload" 
							accept="image/*"
							class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
						/>
					</div>

				<div class="pt-4 space-y-2">
					<button 
						id="regenerate-code-btn"
						class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-200 flex items-center justify-center gap-2">
					üîÑ
						Regenerate Code
					</button>
						<button 
							id="download-btn"
							class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-200 flex items-center justify-center gap-2">
						‚¨áÔ∏è
							Download Voucher
						</button>
					</div>
				</div>

				<!-- Preview -->
				<div class="lg:col-span-2 flex flex-col gap-4">
					<div class="flex items-center justify-center bg-gray-50 p-4 rounded-lg border border-gray-200">
						<div id="voucher-preview" class="relative w-full aspect-video rounded-lg overflow-hidden bg-gray-300 bg-cover bg-center shadow-xl" style="background-image: url('https://placehold.co/800x450?text=Upload+Background');">
							<div class="absolute inset-0 flex items-center justify-center p-8">
								<div class="backdrop-blur-sm bg-white/30 border border-white/20 shadow-sm rounded-xl p-8 w-full max-w-lg text-center flex flex-col gap-4">
									<h2 id="display-title" class="text-4xl font-bold text-gray-900 drop-shadow-sm">Gift Voucher</h2>
									<p id="display-subtitle" class="text-xl font-medium text-gray-800 drop-shadow-sm">A special treat just for you</p>
									
									<div class="my-4 w-1/2 mx-auto border-t border-gray-800/20"></div>
									
									<p id="display-address" class="whitespace-pre-line text-gray-800">123 Main St,
	Cityville, ST 12345</p>
									
									<p class="text-sm mt-2 font-semibold text-gray-700">
										Valid until: <span id="display-valid-till">December 31, 2025</span>
									</p>
									<p class="text-xs mt-1 font-mono text-gray-600 tracking-wider">
										Code: <span id="display-code"></span>
									</p>
								</div>
							</div>
						</div>
					</div>
					<p class="text-sm text-gray-500 text-center italic">Preview may differ slightly from downloaded image.</p>
				</div>
			</div>
		</main>

		<script>
			import html2canvas from 'html2canvas-pro';

			// Elements
			const bgUpload = document.getElementById('bg-upload') as HTMLInputElement;
			const preview = document.getElementById('voucher-preview');
			const downloadBtn = document.getElementById('download-btn');
			const regenerateCodeBtn = document.getElementById('regenerate-code-btn');
			
			const inputs = {
				title: document.getElementById('input-title') as HTMLInputElement,
				subtitle: document.getElementById('input-subtitle') as HTMLInputElement,
				address: document.getElementById('input-address') as HTMLTextAreaElement,
				validTill: document.getElementById('input-valid-till') as HTMLInputElement,
			};

			const displays = {
				title: document.getElementById('display-title'),
				subtitle: document.getElementById('display-subtitle'),
				address: document.getElementById('display-address'),
				validTill: document.getElementById('display-valid-till'),
				code: document.getElementById('display-code'),
			};

			const EXPORT_BLUR_RADIUS = 14;

			function extractBackgroundUrl(element: HTMLElement) {
				const backgroundImage = window.getComputedStyle(element).backgroundImage;
				const match = backgroundImage.match(/url\(["']?(.*?)["']?\)/);
				return match && match[1] !== 'none' ? match[1] : null;
			}

			function loadImage(src: string) {
				return new Promise<HTMLImageElement>((resolve, reject) => {
					const image = new Image();
					image.crossOrigin = 'anonymous';
					image.onload = () => resolve(image);
					image.onerror = reject;
					image.src = src;
				});
			}

			function drawImageCover(ctx: CanvasRenderingContext2D, image: HTMLImageElement, width: number, height: number) {
				const scale = Math.max(width / image.width, height / image.height);
				const drawWidth = image.width * scale;
				const drawHeight = image.height * scale;
				const offsetX = (width - drawWidth) / 2;
				const offsetY = (height - drawHeight) / 2;
				ctx.drawImage(image, offsetX, offsetY, drawWidth, drawHeight);
			}

			async function generateBlurredBackground(element: HTMLElement, blurRadius = EXPORT_BLUR_RADIUS) {
				const imageUrl = extractBackgroundUrl(element);
				if (!imageUrl) {
					return null;
				}

				try {
					const image = await loadImage(imageUrl);
					const width = element.clientWidth || element.getBoundingClientRect().width || 800;
					const height = element.clientHeight || element.getBoundingClientRect().height || 450;
					const canvas = document.createElement('canvas');
					canvas.width = Math.max(1, Math.floor(width));
					canvas.height = Math.max(1, Math.floor(height));
					const ctx = canvas.getContext('2d');
					if (!ctx) {
						return null;
					}

					ctx.filter = `blur(${blurRadius}px)`;
					drawImageCover(ctx, image, canvas.width, canvas.height);
					return canvas.toDataURL('image/png');
				} catch (error) {
					console.warn('Unable to generate blurred background for export:', error);
					return null;
				}
			}

			async function applyBlurredBackgroundForExport(element: HTMLElement) {
				const blurredBackground = await generateBlurredBackground(element);
				const originalBackground = element.style.backgroundImage;

				if (!blurredBackground) {
					return () => {};
				}

				element.style.backgroundImage = `url(${blurredBackground})`;
				await new Promise<void>((resolve) => requestAnimationFrame(() => resolve()));

				return () => {
					element.style.backgroundImage = originalBackground;
				};
			}

			// Generate random 6-character code
			function generateCode() {
				const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
				let code = '';
				for (let i = 0; i < 6; i++) {
					code += chars.charAt(Math.floor(Math.random() * chars.length));
				}
				return code;
			}

			// Set initial code
			if (displays.code) {
				displays.code.textContent = generateCode();
			}

			// Text Updates
			Object.keys(inputs).forEach(key => {
				const input = inputs[key as keyof typeof inputs];
				const display = displays[key as keyof typeof displays];
				
				if (input && display) {
					input.addEventListener('input', (e) => {
						const target = e.target as HTMLInputElement | HTMLTextAreaElement;
						display.textContent = target.value;
					});
				}
			});

			// Background Upload
			if (bgUpload && preview) {
				bgUpload.addEventListener('change', (e) => {
					const target = e.target as HTMLInputElement;
					if (target.files && target.files[0]) {
						const reader = new FileReader();
						reader.onload = (e) => {
							if (e.target?.result) {
								preview.style.backgroundImage = `url(${e.target.result})`;
							}
						};
						reader.readAsDataURL(target.files[0]);
					}
				});
			}

			// Regenerate Code Button
			if (regenerateCodeBtn && displays.code) {
				regenerateCodeBtn.addEventListener('click', () => {
					if (displays.code) {
						displays.code.textContent = generateCode();
					}
				});
			}

			// Download Functionality
			if (downloadBtn && preview) {
				downloadBtn.addEventListener('click', async () => {
					const button = downloadBtn as HTMLButtonElement;
					const originalText = downloadBtn.innerHTML;
					let restoreBackground = () => {};

					try {
						// Regenerate code for new voucher
						if (displays.code) {
							displays.code.textContent = generateCode();
						}

						downloadBtn.innerHTML = 'Generating...';
						button.disabled = true;

						restoreBackground = await applyBlurredBackgroundForExport(preview as HTMLElement);

						const canvas = await html2canvas(preview as HTMLElement, {
							useCORS: true,
							scale: 2,
							backgroundColor: null,
							ignoreElements: (element) => {
								// Skip custom elements and shadow DOM components
								return element.tagName.includes('-');
							}
						});

						const voucherCode = displays.code?.textContent || 'XXXXXX';
						const link = document.createElement('a');
						link.download = `voucher_${voucherCode}.png`;
						link.href = canvas.toDataURL('image/png');
						link.click();
					} catch (err) {
						console.error('Error generating voucher:', err);
						alert('Failed to generate voucher image.');
					} finally {
						restoreBackground();
						downloadBtn.innerHTML = originalText;
						button.disabled = false;
					}
				});
			}
		</script>
	</body>
</html>
